@page "/register"

@* Bu sayfayı "İnteraktif Sunucu" modunda çalıştır.
  Bu komut, butona tıklama (@onclick) ve veri bağlama (@bind)
  gibi C# kodlarının çalışmasını sağlar.
*@
@rendermode InteractiveServer

@using remoview.Dtos
@using Remoview.Web.Services

@inject ApiClient ApiClient
@inject NavigationManager NavigationManager

<h3>Kayıt Ol</h3>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}

@if (!string.IsNullOrEmpty(successMessage))
{
    <div class="alert alert-success">@successMessage</div>
}

<EditForm Model="registerDto" OnValidSubmit="HandleRegister" FormName="registerForm">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="card">
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label">Email Adresi</label>
                <InputText type="email" class="form-control" @bind-Value="registerDto.Email" />
            </div>
            <div class="mb-3">
                <label class="form-label">Şifre</label>
                <InputText type="password" class="form-control" @bind-Value="registerDto.Password" />
            </div>

            <button type="submit" class="btn btn-primary" disabled="@isLoading">
                @if (isLoading)
                {
                    <span class="spinner-border spinner-border-sm" aria-hidden="true"></span>
                }
                Kayıt Ol
            </button>
        </div>
    </div>
</EditForm>


@code {
    private RegisterDto registerDto = new RegisterDto();
    private string? errorMessage;
    private string? successMessage;
    private bool isLoading = false;

    private async Task HandleRegister()
    {
        isLoading = true;
        errorMessage = null;
        successMessage = null;

        try
        {
            var result = await ApiClient.RegisterAsync(registerDto);

            if (result.StartsWith("Hata:"))
            {
                errorMessage = result;
            }
            else
            {
                successMessage = result + " Giriş sayfasına yönlendiriliyorsunuz...";
                await Task.Delay(2000);
                NavigationManager.NavigateTo("/");
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Sunucuya bağlanırken bir hata oluştu: " + ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }
}